<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFL Hype Bulk Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
        }

        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 1.2em;
        }

        .search-phrase {
            background: #e8f4fd;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #2196F3;
            font-size: 1.1em;
        }

        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            align-items: center;
            flex-wrap: wrap;
        }

        .scan-btn {
            background: linear-gradient(45deg, #FF6B6B, #FF8E53);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .scan-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        .scan-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .progress-container {
            display: none;
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 15px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #45a049);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            font-weight: bold;
            color: #333;
        }

        .summary {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border-top: 4px solid #2196F3;
        }

        .summary-card.flagged {
            border-top-color: #f44336;
        }

        .summary-card.clean {
            border-top-color: #4CAF50;
        }

        .summary-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .summary-label {
            color: #666;
            font-size: 0.9em;
        }

        .results-section {
            display: none;
        }

        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 8px 16px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn.active {
            background: #2196F3;
            color: white;
            border-color: #2196F3;
        }

        .results-grid {
            display: grid;
            gap: 15px;
            max-height: 600px;
            overflow-y: auto;
        }

        .result-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #ddd;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .result-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
        }

        .result-item.flagged {
            border-left-color: #f44336;
        }

        .result-item.clean {
            border-left-color: #4CAF50;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-badge.flagged {
            background: #ffebee;
            color: #c62828;
        }

        .status-badge.clean {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .user-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 10px;
            font-size: 0.9em;
            color: #666;
        }

        .user-info strong {
            color: #333;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #2196F3;
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .note {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 30px;
            color: #856404;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèà NFL Hype Bulk Scanner</h1>
        <p class="subtitle">Automatically scan all users from CSV for NFL hype content</p>
        
        <div class="search-phrase">
            <strong>Searching for:</strong> 
            <div style="margin-top: 8px;">
                1. "Got hyped for the 2025-26 NFL season üëè"
            </div>
            <div style="margin-top: 4px;">
                2. "referral üìà" (any username + referral üìà)
            </div>
        </div>

        <div class="controls">
            <button class="scan-btn" onclick="startBulkScan()">
                üöÄ Start Bulk Scan
            </button>
            <button class="scan-btn" onclick="testAPI()" style="background: linear-gradient(45deg, #4CAF50, #45a049); margin-left: 10px;">
                üß™ Test API
            </button>
            <div id="csvStatus" style="color: #666;"></div>
        </div>

        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">
                Preparing scan...
            </div>
        </div>

        <div class="summary" id="summary">
            <div class="summary-card">
                <div class="summary-number" id="totalScanned">0</div>
                <div class="summary-label">Total Scanned</div>
            </div>
            <div class="summary-card flagged">
                <div class="summary-number" id="totalFlagged">0</div>
                <div class="summary-label">Flagged Users</div>
            </div>
            <div class="summary-card clean">
                <div class="summary-number" id="totalClean">0</div>
                <div class="summary-label">Clean Users</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="totalActive">0</div>
                <div class="summary-label">Active Players</div>
            </div>
        </div>

        <div class="results-section" id="resultsSection">
            <div class="filter-controls">
                <button class="filter-btn active" onclick="filterResults('all')">All Results</button>
                <button class="filter-btn" onclick="filterResults('flagged')">üö© Flagged Only</button>
                <button class="filter-btn" onclick="filterResults('clean')">‚úÖ Clean Only</button>
                <button class="filter-btn" onclick="filterResults('active')">üéÆ Active Players</button>
            </div>
            <div class="results-grid" id="resultsGrid"></div>
        </div>

        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Loading CSV data and preparing scan...</p>
        </div>

        <div class="note">
            <strong>How it works:</strong> This scanner fetches the user data from the provided Google Sheets CSV, then makes real API calls to your Cloudflare Worker at <code>https://rkl-worker.tommyek600.workers.dev/</code> to scan each user's content for both target phrases. The system searches through all user items and entities, looking for exact matches for the NFL phrase and pattern matches for referral content (any @username + "referral üìà").
        </div>
    </div>

    <script>
        let userData = [];
        let scanResults = {};
        let currentFilter = 'all';

        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSEEzC1lcmy8r7irgTXLWUJhvEsMgN1YmwUFfAQ2wBQMNTu_L1uXQe_c-tdy9c3PJ416_wtBkyQKlbD/pub?output=csv';

        async function loadCSVData() {
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                
                // Parse CSV manually (simple parser for this format)
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',');
                
                userData = lines.slice(1).map(line => {
                    const values = line.split(',');
                    const user = {};
                    headers.forEach((header, index) => {
                        user[header.trim()] = values[index] ? values[index].trim() : '';
                    });
                    return user;
                });

                document.getElementById('csvStatus').textContent = `‚úÖ Loaded ${userData.length} users from CSV`;
                return true;
            } catch (error) {
                document.getElementById('csvStatus').textContent = `‚ùå Failed to load CSV: ${error.message}`;
                return false;
            }
        }

        async function startBulkScan() {
            const loadingDiv = document.getElementById('loading');
            const progressContainer = document.getElementById('progressContainer');
            const scanBtn = document.querySelector('.scan-btn');
            const summaryDiv = document.getElementById('summary');
            const resultsSection = document.getElementById('resultsSection');

            // Reset previous results
            scanResults = {};
            summaryDiv.style.display = 'none';
            resultsSection.style.display = 'none';

            // Show loading and disable button
            loadingDiv.style.display = 'block';
            scanBtn.disabled = true;

            // Load CSV data if not already loaded
            if (userData.length === 0) {
                const loaded = await loadCSVData();
                if (!loaded) {
                    loadingDiv.style.display = 'none';
                    scanBtn.disabled = false;
                    return;
                }
            }

            // Hide loading, show progress
            loadingDiv.style.display = 'none';
            progressContainer.style.display = 'block';

            // Start scanning users
            await scanAllUsers();

            // Hide progress, show results
            progressContainer.style.display = 'none';
            summaryDiv.style.display = 'grid';
            resultsSection.style.display = 'block';
            scanBtn.disabled = false;

            updateSummary();
            displayResults();
        }

        async function scanAllUsers() {
            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const searchPhrases = [
                "Got hyped for the 2025-26 NFL season üëè",
                "referral üìà"
            ];
            const CONCURRENT_REQUESTS = 10;

            let completedCount = 0;
            let totalUsers = userData.length;

            // Function to update progress
            const updateProgress = () => {
                const progress = (completedCount / totalUsers) * 100;
                progressFill.style.width = `${progress}%`;
                progressText.textContent = `Scanning users... (${completedCount}/${totalUsers} completed)`;
            };

            // Function to scan a single user
            const scanSingleUser = async (user, index) => {
                const userId = user['User ID'] || '';

                // Skip users without valid User ID
                if (!userId || userId === 'NOT FOUND' || userId === 'Not Found') {
                    scanResults[userId || `unknown_${index}`] = {
                        user: user,
                        found: false,
                        phrases: searchPhrases,
                        context: 'Invalid or missing User ID',
                        timestamp: new Date().toISOString(),
                        proxyUsed: false,
                        error: 'No valid User ID'
                    };
                    completedCount++;
                    updateProgress();
                    return;
                }

                try {
                    // Make real API call to Cloudflare Worker
                    const result = await scanUserContent(userId, searchPhrases);
                    
                    // Store scan result
                    scanResults[userId] = {
                        user: user,
                        found: result.found,
                        phrases: searchPhrases,
                        context: result.context,
                        foundInItem: result.foundInItem,
                        foundPhrases: result.foundPhrases,
                        timestamp: new Date().toISOString(),
                        proxyUsed: true,
                        apiResponse: result.apiResponse
                    };

                } catch (error) {
                    console.error(`Error scanning user ${userId}:`, error);
                    
                    // Store error result
                    scanResults[userId] = {
                        user: user,
                        found: false,
                        phrases: searchPhrases,
                        context: `API Error: ${error.message}`,
                        timestamp: new Date().toISOString(),
                        proxyUsed: false,
                        error: error.message
                    };
                }

                completedCount++;
                updateProgress();
            };

            // Process users in batches of CONCURRENT_REQUESTS
            for (let i = 0; i < userData.length; i += CONCURRENT_REQUESTS) {
                const batch = userData.slice(i, i + CONCURRENT_REQUESTS);
                const batchPromises = batch.map((user, batchIndex) => 
                    scanSingleUser(user, i + batchIndex)
                );

                // Wait for current batch to complete before starting next batch
                await Promise.all(batchPromises);

                // Small delay between batches to be respectful to the API
                if (i + CONCURRENT_REQUESTS < userData.length) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }
        }

        async function scanUserContent(userId, searchPhrases) {
            const WORKER_URL = 'https://rkl-worker.tommyek600.workers.dev/';
            
            try {
                // Make request to Cloudflare Worker without Content-Type header to avoid CORS preflight
                const response = await fetch(`${WORKER_URL}?userId=${encodeURIComponent(userId)}`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'omit'
                    // Removed headers that trigger CORS preflight
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                // Search through the items for any of the target phrases
                let found = false;
                let context = 'No matches found in user content';
                let foundInItem = null;
                let foundPhrases = [];

                if (data.items && Array.isArray(data.items)) {
                    for (const item of data.items) {
                        if (item.entities && Array.isArray(item.entities)) {
                            for (const entity of item.entities) {
                                if (entity.display) {
                                    // Check for each search phrase
                                    for (const phrase of searchPhrases) {
                                        let phraseFound = false;
                                        
                                        if (phrase === "referral üìà") {
                                            // For referral, search for the pattern regardless of username
                                            phraseFound = entity.display.includes("referral üìà");
                                        } else {
                                            // For other phrases, exact match
                                            phraseFound = entity.display.includes(phrase);
                                        }
                                        
                                        if (phraseFound) {
                                            found = true;
                                            foundPhrases.push({
                                                phrase: phrase,
                                                fullText: entity.display,
                                                itemId: item.id,
                                                itemType: item.type
                                            });
                                            foundInItem = item.id;
                                        }
                                    }
                                }
                            }
                        }
                    }
                    
                    if (found) {
                        const phraseTypes = [...new Set(foundPhrases.map(fp => 
                            fp.phrase === "referral üìà" ? "referral" : "NFL hype"
                        ))];
                        context = `Found ${foundPhrases.length} match(es) for: ${phraseTypes.join(", ")} - in ${foundPhrases.length} item(s)`;
                    } else {
                        context = `Scanned ${data.items.length} items - no matches found`;
                    }
                } else {
                    context = 'No items found in user data';
                }

                return {
                    found: found,
                    context: context,
                    foundInItem: foundInItem,
                    foundPhrases: foundPhrases,
                    apiResponse: data
                };

            } catch (error) {
                // More detailed error logging
                console.error(`Fetch error for user ${userId}:`, {
                    message: error.message,
                    name: error.name,
                    stack: error.stack
                });
                
                throw new Error(`Failed to fetch user data: ${error.message}`);
            }
        }

        function updateSummary() {
            const results = Object.values(scanResults);
            const totalScanned = results.length;
            const totalFlagged = results.filter(r => r.found).length;
            const totalClean = totalScanned - totalFlagged;
            const totalActive = results.filter(r => r.user['playing?'] === 'yes').length;

            document.getElementById('totalScanned').textContent = totalScanned;
            document.getElementById('totalFlagged').textContent = totalFlagged;
            document.getElementById('totalClean').textContent = totalClean;
            document.getElementById('totalActive').textContent = totalActive;
        }

        function displayResults() {
            const resultsGrid = document.getElementById('resultsGrid');
            const results = Object.values(scanResults);

            let filteredResults = results;
            if (currentFilter === 'flagged') {
                filteredResults = results.filter(r => r.found);
            } else if (currentFilter === 'clean') {
                filteredResults = results.filter(r => !r.found);
            } else if (currentFilter === 'active') {
                filteredResults = results.filter(r => r.user['playing?'] === 'yes');
            }

            resultsGrid.innerHTML = filteredResults.map(result => {
                const user = result.user;
                const statusClass = result.found ? 'flagged' : 'clean';
                const statusText = result.found ? 'üö© FLAGGED' : '‚úÖ CLEAN';

                return `
                    <div class="result-item ${statusClass}">
                        <div class="result-header">
                            <strong>${user['User @'] || 'Unknown User'}</strong>
                            <span class="status-badge ${statusClass}">${statusText}</span>
                        </div>
                        <div class="user-info">
                            <div><strong>Team:</strong> ${user['Team'] || 'N/A'}</div>
                            <div><strong>Role:</strong> ${user['role'] || 'N/A'}</div>
                            <div><strong>Active:</strong> ${user['playing?'] === 'yes' ? '‚úÖ Yes' : '‚ùå No'}</div>
                            <div><strong>User ID:</strong> ${user['User ID'] || 'N/A'}</div>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.9em; color: ${result.found ? '#c62828' : '#666'};">
                            <strong>Scan Result:</strong> ${result.context}
                            ${result.error ? `<br><span style="color: #ff9800;"><strong>Error:</strong> ${result.error}</span>` : ''}
                            ${result.foundInItem ? `<br><strong>Item ID:</strong> ${result.foundInItem}` : ''}
                            ${result.foundPhrases && result.foundPhrases.length > 0 ? 
                                `<br><strong>Found Content:</strong><br>${result.foundPhrases.map(fp => 
                                    `<span style="background: #f0f0f0; padding: 2px 4px; border-radius: 3px; display: inline-block; margin: 2px 0; font-size: 0.85em;">"${fp.fullText}"</span>`
                                ).join('<br>')}` : ''
                            }
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterResults(filter) {
            currentFilter = filter;
            
            // Update active filter button
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            displayResults();
        }

        // Test API function
        async function testAPI() {
            const testUserId = 'Gv1Ajxrv'; // Known working user ID from your example
            const csvStatus = document.getElementById('csvStatus');
            
            csvStatus.textContent = 'üß™ Testing API connection...';
            csvStatus.style.color = '#2196F3';
            
            try {
                const result = await scanUserContent(testUserId, ["Got hyped for the 2025-26 NFL season üëè", "referral üìà"]);
                csvStatus.innerHTML = `‚úÖ API Test Successful!<br>Found: ${result.found ? 'Yes' : 'No'}<br>Context: ${result.context}`;
                csvStatus.style.color = '#4CAF50';
            } catch (error) {
                csvStatus.innerHTML = `‚ùå API Test Failed:<br>${error.message}<br><br>Troubleshooting:<br>1. Check if your Cloudflare Worker has CORS headers<br>2. Try opening <a href="https://rkl-worker.tommyek600.workers.dev/?userId=Gv1Ajxrv" target="_blank">this URL</a> directly<br>3. Check browser console for more details`;
                csvStatus.style.color = '#f44336';
                console.error('API Test Error:', error);
            }
        }

        // Load CSV data on page load
        window.addEventListener('load', () => {
            loadCSVData();
        });
    </script>
</body>
</html>
